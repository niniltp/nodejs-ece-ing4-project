<!DOCTYPE html>
<html lang="en">

<head>
    <% include partials/head.ejs %>
    <script src="https://d3js.org/d3.v4.js"></script>
</head>

<body class="container">
    <div id="form">
        <h1>Salut salut les graphs et jane!</h1>
        <div id="my_dataviz"></div>
        <svg class="line-chart"></svg>
        <script type="text/javascript">
            //API to fetch historical data of Bitcoin Price Index

            const api = '/users/jane/metrics';


            /**
             * Loading data from API when DOM Content has been loaded'.
             */
            document.addEventListener("DOMContentLoaded", function (event) {

                fetch('/users/jane/metrics')
                    .then(res => res.json())
                    .then(res => {
                        console.log(res);
                        var parsedData = parseData(res);
                        drawChart(parsedData);
                    })
                    .catch(function (error) { console.log(error); });
            });

            /**
             * Parse data into key-value pairs
             * @param {object} data Object containing historical data of BPI
             */
            function parseData(data) {
                var arr = [];

                const content = data.map(d => {
                    arr.push({
                        timestamp: d.timestamp,
                        value: d.value,
                    });
                })
                return arr;

            }

            /**
             * Creates a chart using D3
             * @param {object} data Object containing historical data of BPI
             */
            function drawChart(data) {
                var svgWidth = 900, svgHeight = 400;
                var margin = { top: 20, right: 20, bottom: 30, left: 50 };
                var width = svgWidth - margin.left - margin.right;
                var height = svgHeight - margin.top - margin.bottom;

                var svg = d3.select('svg')
                    .attr("width", svgWidth)
                    .attr("height", svgHeight);

                var g = svg.append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                var x = d3.scaleTime()
                    .rangeRound([0, width]);


                var y = d3.scaleLinear()
                    .domain([d3.min(data), d3.max(data)])
                    .rangeRound([height, 0]);

                var line = d3.line()
                    .x(function (d) { return x(d.timestamp) })
                    .y(function (d) { return y(d.value) })
                x.domain(d3.extent(data, function (d) { return d.timestamp }));
                y.domain(d3.extent(data, function (d) { return d.value }));

                g.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x))
                    ;

                g.append("g")
                    .call(d3.axisLeft(y))
                    .append("text")
                    .attr("fill", "#000")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "0.71em")
                    .attr("text-anchor", "end")
                    .text("Value");

                g.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke-width", 1.5)
                    .attr("d", line);
            }

        </script>

    </div>
</body>

</html>